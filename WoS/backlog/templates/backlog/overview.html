{% extends 'backlog/base.html' %}
{% load static %}

{% block title %}Backlog â€” Epics{% endblock %}

{% block content %}
<div class="page-head">
  <h2>ğŸ“ {% if show_archived %}Archived {% endif %}Epics</h2>
  <div class="page-actions">
    {% if show_archived %}
      <a class="btn" href="{% url 'backlog:index' %}">â† Active Epics</a>
    {% else %}
      <a class="btn" href="{% url 'backlog:index' %}?archived=1">ğŸ“¦ View Archived</a>
      <a class="btn" href="{% url 'backlog:create_epic' %}">â• Create Epic</a>
    {% endif %}
  </div>
</div>

<div class="page-hint">
  {% if show_archived %}
  <strong>ğŸ“¦ Archived Epics:</strong> These epics have been archived and are hidden from the main view.
  You can unarchive them to bring them back.
  {% else %}
  <strong>ğŸ’¡ Tip:</strong> Epics are large bodies of work that contain multiple stories. 
  Create epics to organize your backlog into manageable themes or features.
  {% endif %}
</div>

<form method="get" class="filters" style="margin-bottom:12px;display:flex;gap:8px;flex-wrap:wrap;align-items:center">
  {% if show_archived %}<input type="hidden" name="archived" value="1">{% endif %}
  <input name="q" placeholder="ğŸ” Search epics..." value="{{ q }}">
  <button class="btn" type="submit">Search</button>
</form>

<table class="overview-table" style="margin-top:12px;">
  <thead>
    <tr>
      <th>Actions</th>
      <th>
        <a href="?{% if q %}q={{ q }}&{% endif %}{% if show_archived %}archived=1&{% endif %}sort=title&order={% if sort == 'title' and order == 'asc' %}desc{% else %}asc{% endif %}">
          Epic
          {% if sort == 'title' %}{% if order == 'asc' %} â–² {% else %} â–¼ {% endif %}{% endif %}
        </a>
      </th>
      <th>
        <a href="?{% if q %}q={{ q }}&{% endif %}{% if show_archived %}archived=1&{% endif %}sort=stories&order={% if sort == 'stories' and order == 'asc' %}desc{% else %}asc{% endif %}">
          ğŸ“‹ Stories
          {% if sort == 'stories' %}{% if order == 'asc' %} â–² {% else %} â–¼ {% endif %}{% endif %}
        </a>
      </th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    {% for item in epics %}
      <tr>
        <td style="white-space:nowrap;">
          {% if show_archived %}
            <form method="post" action="" style="display:inline;">
              {% csrf_token %}
              <input type="hidden" name="action" value="unarchive_epic">
              <input type="hidden" name="epic_id" value="{{ item.epic.id }}">
              <button type="submit" title="Unarchive epic" style="background:none;border:0;padding:0;margin:0;cursor:pointer;">ğŸ“¤</button>
            </form>
          {% else %}
            <form method="post" action="" style="display:inline;" onsubmit="{% if item.unfinished_count > 0 %}return confirm('This epic has {{ item.unfinished_count }} unfinished story/stories. Archiving will also archive all stories in this epic. Continue?');{% endif %}">
              {% csrf_token %}
              <input type="hidden" name="action" value="archive_epic">
              <input type="hidden" name="epic_id" value="{{ item.epic.id }}">
              <button type="submit" title="Archive epic{% if item.unfinished_count > 0 %} ({{ item.unfinished_count }} unfinished){% endif %}" style="background:none;border:0;padding:0;margin:0;cursor:pointer;">ğŸ“¦</button>
            </form>
          {% endif %}
          <a href="{% url 'backlog:edit_epic' item.epic.id %}" title="Edit epic" style="margin-left:8px;">âœï¸</a>
          <a href="{% url 'backlog:stories' %}?epic={{ item.epic.id }}" title="View stories in this epic" style="margin-left:8px;">ğŸ“„</a>
          <form method="post" action="" style="display:inline;margin-left:8px;">
            {% csrf_token %}
            <input type="hidden" name="action" value="delete_epic">
            <input type="hidden" name="epic_id" value="{{ item.epic.id }}">
            <button type="submit" title="Delete epic" style="background:none;border:0;padding:0;margin:0;cursor:pointer;">ğŸ—‘ï¸</button>
          </form>
        </td>
        <td><a href="{% url 'backlog:stories' %}?epic={{ item.epic.id }}" class="table-link">{{ item.epic.title }}</a></td>
        <td style="text-align:center;">{{ item.epic.stories.count }}</td>
        <td style="color:var(--muted);">{{ item.description|default:'â€”'|truncatechars:60 }}</td>
      </tr>
    {% empty %}
      <tr>
        <td colspan="4">
          <div class="empty-state">
            <div class="empty-icon">{% if show_archived %}ğŸ“¦{% else %}ğŸ“{% endif %}</div>
            <div class="empty-text">No {% if show_archived %}archived {% endif %}epics {% if show_archived %}{% else %}yet{% endif %}</div>
            <div class="empty-hint">{% if show_archived %}No epics have been archived.{% else %}Create your first epic to start organizing your backlog!{% endif %}</div>
          </div>
        </td>
      </tr>
    {% endfor %}
  </tbody>
</table>

{% endblock %}