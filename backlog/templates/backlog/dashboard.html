{% extends 'backlog/base.html' %}
{% load static %}

{% block title %}Dashboard ‚Äî WoS{% endblock %}

{% block content %}
<div class="page-head">
  <h2>üìä Dashboard</h2>
  <div class="page-actions">
    <a class="btn" href="{% url 'backlog:stories' %}">üìã All Stories</a>
  </div>
</div>

<div class="page-hint">
  <strong>üéØ Stories Needing Attention:</strong> This dashboard highlights stories that require action ‚Äî 
  scoring, refinement, or have become stale. Address these to keep your backlog healthy.
</div>

<!-- Quick Create Story -->
<div class="dashboard-section quick-create">
  <div class="section-header">
    <h3>‚ö° Quick Create Story</h3>
    <span class="section-count">Add title only</span>
  </div>
  <div class="section-hint">Create a story fast; you can refine details and scoring next.</div>
  <form method="post" class="quick-create-form">
    {% csrf_token %}
    <input type="hidden" name="action" value="quick_create_story">
    <div class="quick-create-fields">
      <input type="text" name="title" placeholder="Story title" required>
      <button type="submit" class="btn">Create ‚Üí Refine</button>
    </div>
  </form>
</div>

<!-- Summary Cards -->
<div class="dashboard-summary">
  <div class="summary-card summary-review">
    <div class="summary-icon">üëÄ</div>
    <div class="summary-value">{{ summary.review_required }}</div>
    <div class="summary-label">Need Review</div>
  </div>
  <div class="summary-card summary-scoring">
    <div class="summary-icon">üéØ</div>
    <div class="summary-value">{{ summary.needs_scoring }}</div>
    <div class="summary-label">Need Scoring</div>
  </div>
  <div class="summary-card summary-refinement">
    <div class="summary-icon">‚úèÔ∏è</div>
    <div class="summary-value">{{ summary.needs_refinement }}</div>
    <div class="summary-label">Need Refinement</div>
  </div>
  <div class="summary-card summary-rotting">
    <div class="summary-icon">‚è∞</div>
    <div class="summary-value">{{ summary.rotting }}</div>
    <div class="summary-label">Rotting Stories</div>
  </div>
  <div class="summary-card summary-housekeeping">
    <div class="summary-icon">üßπ</div>
    <div class="summary-value">{{ summary.housekeeping }}</div>
    <div class="summary-label">Housekeeping</div>
  </div>
  <div class="summary-card summary-healthy">
    <div class="summary-icon">‚úÖ</div>
    <div class="summary-value">{{ summary.healthy }}</div>
    <div class="summary-label">Healthy</div>
  </div>
</div>

<!-- Review Required Section (FIRST - Most Important) -->
<div class="dashboard-section">
  <div class="section-header">
    <h3>üëÄ Review Required</h3>
    <span class="section-count">{{ summary.review_required }} stories</span>
  </div>
  <div class="section-hint">Stories that have been flagged for review by team members. Address these first!</div>
  
  {% if review_required %}
  <table class="dashboard-table">
    <thead>
      <tr>
        <th>Story</th>
        <th>Status</th>
        <th>Created</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody>
      {% for item in review_required %}
      <tr>
        <td><a href="{% url 'backlog:story_detail' item.story.id %}" class="table-link">{{ item.story.title|truncatechars:50 }}</a></td>
        <td><span class="status-{{ item.story.computed_status }}">{{ item.story.computed_status|title }}</span></td>
        <td class="text-muted">{{ item.story.created_at|date:"M d, Y" }}</td>
        <td><a href="{% url 'backlog:story_detail' item.story.id %}" class="btn btn-small">Review ‚Üí</a></td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% else %}
  <div class="empty-state-small">
    <span class="empty-icon">‚úÖ</span>
    <span class="empty-text">No stories flagged for review!</span>
  </div>
  {% endif %}
</div>

<!-- Needs Scoring Section -->
<div class="dashboard-section">
  <div class="section-header">
    <h3>üéØ Stories Needing Scoring</h3>
    <span class="section-count">{{ summary.needs_scoring }} stories</span>
  </div>
  <div class="section-hint">These stories are missing value or cost factor scores. Score them to calculate WSJF priority.</div>
  
  {% if needs_scoring %}
  <table class="dashboard-table">
    <thead>
      <tr>
        <th>Story</th>
        <th>Status</th>
        <th>Missing</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody>
      {% for item in needs_scoring %}
      <tr>
        <td><a href="{% url 'backlog:story_detail' item.story.id %}" class="table-link">{{ item.story.title|truncatechars:50 }}</a></td>
        <td><span class="status-{{ item.story.computed_status }}">{{ item.story.computed_status|title }}</span></td>
        <td class="text-muted">
          {% if item.missing_value_count %}{{ item.missing_value_count }} value{% endif %}
          {% if item.missing_value_count and item.missing_cost_count %}, {% endif %}
          {% if item.missing_cost_count %}{{ item.missing_cost_count }} cost{% endif %}
        </td>
        <td><a href="{% url 'backlog:story_detail' item.story.id %}" class="btn btn-small">Score ‚Üí</a></td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% else %}
  <div class="empty-state-small">
    <span class="empty-icon">‚úÖ</span>
    <span class="empty-text">All stories are scored!</span>
  </div>
  {% endif %}
</div>

<!-- Needs Refinement Section -->
<div class="dashboard-section">
  <div class="section-header">
    <h3>‚úèÔ∏è Stories Needing Refinement</h3>
    <span class="section-count">{{ summary.needs_refinement }} stories</span>
  </div>
  <div class="section-hint">These stories are in "Idea" status ‚Äî missing a goal or work items. Refine them to make them actionable.</div>
  
  {% if needs_refinement %}
  <table class="dashboard-table">
    <thead>
      <tr>
        <th>Story</th>
        <th>Missing</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody>
      {% for item in needs_refinement %}
      <tr>
        <td><a href="{% url 'backlog:story_detail' item.story.id %}" class="table-link">{{ item.story.title|truncatechars:50 }}</a></td>
        <td class="text-muted">
          {% for field in item.missing %}
            {{ field|title }}{% if not forloop.last %}, {% endif %}
          {% endfor %}
        </td>
        <td><a href="{% url 'backlog:story_detail' item.story.id %}" class="btn btn-small">Refine ‚Üí</a></td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% else %}
  <div class="empty-state-small">
    <span class="empty-icon">‚úÖ</span>
    <span class="empty-text">All stories are refined!</span>
  </div>
  {% endif %}
</div>

<!-- Rotting Stories Section -->
<div class="dashboard-section">
  <div class="section-header">
    <h3>‚è∞ Rotting Stories</h3>
    <span class="section-count">{{ summary.rotting }} stories</span>
  </div>
  <div class="section-hint">
    Stories that have been blocked ({{ thresholds.blocked_days }}+ days), 
    started without progress ({{ thresholds.started_days }}+ days), 
    or planned but not started ({{ thresholds.planned_days }}+ days).
  </div>
  
  {% if rotting_stories %}
  <table class="dashboard-table">
    <thead>
      <tr>
        <th>Story</th>
        <th>Status</th>
        <th>Days</th>
        <th>Reason</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody>
      {% for item in rotting_stories %}
      <tr class="{% if item.reason == 'blocked' %}row-danger{% elif item.reason == 'started' %}row-warning{% else %}row-info{% endif %}">
        <td><a href="{% url 'backlog:story_detail' item.story.id %}" class="table-link">{{ item.story.title|truncatechars:50 }}</a></td>
        <td><span class="status-{{ item.story.computed_status }}">{{ item.story.computed_status|title }}</span></td>
        <td><strong>{{ item.days }}</strong> days</td>
        <td>
          {% if item.reason == 'blocked' %}
            <span class="badge badge-danger">üö´ Blocked{% if item.blocked_reason %}: {{ item.blocked_reason|truncatechars:20 }}{% endif %}</span>
          {% elif item.reason == 'started' %}
            <span class="badge badge-warning">‚ö†Ô∏è Stalled</span>
          {% else %}
            <span class="badge badge-info">üìÖ Waiting to start</span>
          {% endif %}
        </td>
        <td><a href="{% url 'backlog:story_detail' item.story.id %}" class="btn btn-small">Review ‚Üí</a></td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% else %}
  <div class="empty-state-small">
    <span class="empty-icon">‚úÖ</span>
    <span class="empty-text">No rotting stories!</span>
  </div>
  {% endif %}
</div>

<!-- Housekeeping Section -->
<div class="dashboard-section housekeeping-section">
  <div class="section-header">
    <h3>üßπ Housekeeping</h3>
    <span class="section-count">{{ housekeeping.total_issues }} issues</span>
  </div>
  <div class="section-hint">Data integrity issues and cleanup tasks. Some can be automatically fixed, others require manual attention.</div>
  
  {% if housekeeping.issues %}
  <div class="housekeeping-grid">
    {% for issue in housekeeping.issues %}
    <div class="housekeeping-card housekeeping-{{ issue.severity }}">
      <div class="housekeeping-header">
        <span class="housekeeping-icon">{{ issue.icon }}</span>
        <span class="housekeeping-title">{{ issue.title }}</span>
        <span class="housekeeping-count">{{ issue.count }}</span>
      </div>
      <div class="housekeeping-description">{{ issue.description }}</div>
      
      {% if issue.items %}
      <div class="housekeeping-items">
        {% for item in issue.items %}
        <div class="housekeeping-item">
          {{ item }}
        </div>
        {% endfor %}
        {% if issue.count > 10 %}
        <div class="housekeeping-more">... and {{ issue.count|add:"-10" }} more</div>
        {% endif %}
      </div>
      {% endif %}
      
      {% if issue.action %}
      <form method="post" class="housekeeping-action">
        {% csrf_token %}
        <input type="hidden" name="action" value="{{ issue.action }}">
        <button type="submit" class="btn btn-small btn-cleanup" onclick="return confirm('Are you sure you want to clean up {{ issue.count }} {{ issue.title|lower }}?');">
          üßπ Clean Up
        </button>
      </form>
      {% endif %}
    </div>
    {% endfor %}
  </div>
  {% else %}
  <div class="empty-state-small">
    <span class="empty-icon">‚ú®</span>
    <span class="empty-text">No housekeeping issues! Your data is clean.</span>
  </div>
  {% endif %}
</div>

<!-- Statistics Section -->
<div class="dashboard-section statistics-section">
  <div class="section-header">
    <h3>üìà Statistics</h3>
    <span class="section-count">Backlog Overview</span>
  </div>
  <div class="section-hint">Informational metrics about your backlog health and trends.</div>
  
  <div class="statistics-grid">
    <!-- Overview Stats -->
    <div class="stat-card stat-overview">
      <div class="stat-header">
        <span class="stat-icon">üì¶</span>
        <span class="stat-title">Backlog Overview</span>
      </div>
      <div class="stat-content">
        <div class="stat-row">
          <span class="stat-label">Total Stories</span>
          <span class="stat-value">{{ statistics.total_stories }}</span>
        </div>
        <div class="stat-row">
          <span class="stat-label">Active Stories</span>
          <span class="stat-value">{{ statistics.active_stories }}</span>
        </div>
        <div class="stat-row">
          <span class="stat-label">Archived Stories</span>
          <span class="stat-value text-muted">{{ statistics.archived_stories }}</span>
        </div>
      </div>
    </div>
    
    <!-- Status Distribution -->
    <div class="stat-card stat-status">
      <div class="stat-header">
        <span class="stat-icon">üìä</span>
        <span class="stat-title">Status Distribution</span>
      </div>
      <div class="stat-content">
        {% for status, count in statistics.status_counts.items %}
        <div class="stat-row">
          <span class="stat-label"><span class="status-{{ status }}">{{ status|title }}</span></span>
          <span class="stat-value">{{ count }}</span>
        </div>
        {% empty %}
        <div class="stat-empty">No active stories</div>
        {% endfor %}
      </div>
    </div>
    
    <!-- Recently Completed -->
    <div class="stat-card stat-completed">
      <div class="stat-header">
        <span class="stat-icon">‚úÖ</span>
        <span class="stat-title">Recently Completed (30d)</span>
      </div>
      <div class="stat-content">
        {% for story in statistics.recently_completed %}
        <div class="stat-row">
          <span class="stat-label"><a href="{% url 'backlog:story_detail' story.id %}" class="stat-link">{{ story.title|truncatechars:25 }}</a></span>
          <span class="stat-value text-muted">{{ story.finished|date:"M d" }}</span>
        </div>
        {% empty %}
        <div class="stat-empty">No completions in last 30 days</div>
        {% endfor %}
      </div>
    </div>
    
    <!-- Oldest Open Stories -->
    <div class="stat-card stat-oldest">
      <div class="stat-header">
        <span class="stat-icon">üï∞Ô∏è</span>
        <span class="stat-title">Oldest Open Stories</span>
      </div>
      <div class="stat-content">
        {% for story in statistics.oldest_open %}
        <div class="stat-row">
          <span class="stat-label"><a href="{% url 'backlog:story_detail' story.id %}" class="stat-link">{{ story.title|truncatechars:25 }}</a></span>
          <span class="stat-value text-muted">{{ story.created_at|date:"M d, Y" }}</span>
        </div>
        {% empty %}
        <div class="stat-empty">No open stories</div>
        {% endfor %}
      </div>
    </div>
    
    <!-- Stories Blocking Others -->
    <div class="stat-card stat-blocking">
      <div class="stat-header">
        <span class="stat-icon">üöß</span>
        <span class="stat-title">Blocking Stories</span>
      </div>
      <div class="stat-content">
        {% for item in statistics.blocking_stories %}
        <div class="stat-row">
          <span class="stat-label"><a href="{% url 'backlog:story_detail' item.story.id %}" class="stat-link">{{ item.story.title|truncatechars:25 }}</a></span>
          <span class="stat-value">blocks {{ item.dependent_count }}</span>
        </div>
        {% empty %}
        <div class="stat-empty">No blocking dependencies</div>
        {% endfor %}
      </div>
    </div>
  </div>
</div>

<style>
/* Dashboard Summary Cards */
.dashboard-summary {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 16px;
  margin-bottom: 24px;
}

.summary-card {
  background: var(--panel);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 20px;
  text-align: center;
  transition: transform 0.15s, box-shadow 0.15s;
}

.summary-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.08);
}

.summary-icon {
  font-size: 28px;
  margin-bottom: 8px;
}

.summary-value {
  font-size: 32px;
  font-weight: 700;
  line-height: 1;
  margin-bottom: 4px;
}

.summary-label {
  font-size: 12px;
  color: var(--muted);
  font-weight: 500;
}

.summary-scoring .summary-value { color: var(--accent); }
.summary-refinement .summary-value { color: #7c3aed; }
.summary-rotting .summary-value { color: var(--warning); }
.summary-review .summary-value { color: #0891b2; }
.summary-housekeeping .summary-value { color: #64748b; }
.summary-healthy .summary-value { color: var(--accent-2); }

/* Dashboard Sections */
.dashboard-section {
  background: var(--panel);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 20px;
}

.section-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
}

.section-header h3 {
  margin: 0;
  font-size: 16px;
  font-weight: 600;
}

.section-count {
  font-size: 13px;
  color: var(--muted);
  background: var(--bg);
  padding: 4px 10px;
  border-radius: 12px;
}

.section-hint {
  font-size: 13px;
  color: var(--muted);
  margin-bottom: 16px;
}

/* Dashboard Table */
.dashboard-table {
  width: 100%;
  border-collapse: collapse;
}

.dashboard-table th,
.dashboard-table td {
  padding: 10px 12px;
  text-align: left;
  border-bottom: 1px solid var(--border);
}

.dashboard-table th {
  font-weight: 600;
  font-size: 12px;
  text-transform: uppercase;
  color: var(--muted);
  background: var(--bg);
}

.dashboard-table tbody tr:hover {
  background: var(--bg);
}

.dashboard-table tbody tr:last-child td {
  border-bottom: none;
}

/* Row highlights for rotting stories */
.row-danger { background: rgba(225, 29, 72, 0.05); }
.row-warning { background: rgba(245, 158, 11, 0.05); }
.row-info { background: rgba(37, 99, 235, 0.05); }

/* Badges */
.badge {
  display: inline-block;
  padding: 4px 8px;
  border-radius: 6px;
  font-size: 12px;
  font-weight: 500;
}

.badge-danger {
  background: rgba(225, 29, 72, 0.1);
  color: var(--danger);
}

.badge-warning {
  background: rgba(245, 158, 11, 0.1);
  color: #b45309;
}

.badge-info {
  background: rgba(37, 99, 235, 0.1);
  color: var(--accent);
}

/* Small button */
.btn-small {
  padding: 4px 10px;
  font-size: 12px;
}

/* Text utilities */
.text-muted {
  color: var(--muted);
}

/* Empty state for sections */
.empty-state-small {
  text-align: center;
  padding: 24px;
  color: var(--muted);
}

.empty-state-small .empty-icon {
  font-size: 24px;
  margin-right: 8px;
}

.empty-state-small .empty-text {
  font-size: 14px;
}

/* Responsive */
@media (max-width: 768px) {
  .dashboard-summary {
    grid-template-columns: repeat(2, 1fr);
  }
  
  .dashboard-table {
    font-size: 13px;
  }
  
  .dashboard-table th,
  .dashboard-table td {
    padding: 8px;
  }
}

/* Housekeeping Section */
.housekeeping-section {
  background: linear-gradient(135deg, var(--panel), rgba(100, 116, 139, 0.02));
}

.housekeeping-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
  gap: 16px;
}

.housekeeping-card {
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 16px;
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.housekeeping-warning {
  border-left: 3px solid var(--warning);
}

.housekeeping-info {
  border-left: 3px solid var(--accent);
}

.housekeeping-header {
  display: flex;
  align-items: center;
  gap: 8px;
}

.housekeeping-icon {
  font-size: 18px;
}

.housekeeping-title {
  font-weight: 600;
  flex: 1;
}

.housekeeping-count {
  background: var(--panel);
  border: 1px solid var(--border);
  padding: 2px 8px;
  border-radius: 12px;
  font-size: 12px;
  font-weight: 600;
  color: var(--muted);
}

.housekeeping-description {
  font-size: 13px;
  color: var(--muted);
}

.housekeeping-items {
  background: var(--panel);
  border: 1px solid var(--border);
  border-radius: 6px;
  padding: 8px;
  font-size: 12px;
  max-height: 150px;
  overflow-y: auto;
}

.housekeeping-item {
  padding: 4px 0;
  border-bottom: 1px solid var(--border);
  display: flex;
  flex-direction: column;
}

.housekeeping-item:last-child {
  border-bottom: none;
}

.item-title {
  font-weight: 500;
}

.item-meta {
  font-size: 11px;
  color: var(--muted);
}

.item-link {
  color: var(--accent);
  text-decoration: none;
}

.item-link:hover {
  text-decoration: underline;
}

.housekeeping-more {
  font-size: 11px;
  color: var(--muted);
  font-style: italic;
  padding-top: 4px;
}

/* Quick Create */
.quick-create input[type="text"] {
  width: 100%;
  max-width: 480px;
  padding: 10px 12px;
  border: 1px solid var(--border);
  border-radius: 8px;
  background: var(--panel);
  color: var(--text);
}

.quick-create-fields {
  display: flex;
  gap: 12px;
  align-items: center;
  margin-top: 8px;
  flex-wrap: wrap;
}

.quick-create .btn {
  padding: 10px 14px;
}

.housekeeping-action {
  margin-top: auto;
  padding-top: 8px;
}

.btn-cleanup {
  background: var(--panel);
  border: 1px solid var(--border);
  color: var(--text);
}

.btn-cleanup:hover {
  background: var(--bg);
  border-color: var(--accent);
}

.action-hint {
  font-size: 12px;
  color: var(--muted);
}

@media (max-width: 768px) {
  .housekeeping-grid {
    grid-template-columns: 1fr;
  }
}

/* Statistics Section */
.statistics-section {
  background: linear-gradient(135deg, var(--panel), rgba(59, 130, 246, 0.02));
}

.statistics-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
  gap: 16px;
}

.stat-card {
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 16px;
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.stat-header {
  display: flex;
  align-items: center;
  gap: 8px;
  padding-bottom: 8px;
  border-bottom: 1px solid var(--border);
}

.stat-icon {
  font-size: 18px;
}

.stat-title {
  font-weight: 600;
  font-size: 14px;
}

.stat-content {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.stat-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 13px;
}

.stat-label {
  color: var(--text);
}

.stat-value {
  font-weight: 600;
  color: var(--accent);
}

.stat-link {
  color: var(--accent);
  text-decoration: none;
}

.stat-link:hover {
  text-decoration: underline;
}

.stat-empty {
  font-size: 12px;
  color: var(--muted);
  font-style: italic;
  text-align: center;
  padding: 8px;
}

.stat-overview { border-left: 3px solid var(--accent); }
.stat-status { border-left: 3px solid #7c3aed; }
.stat-epics { border-left: 3px solid #f59e0b; }
.stat-completed { border-left: 3px solid var(--accent-2); }
.stat-oldest { border-left: 3px solid #64748b; }
.stat-blocking { border-left: 3px solid #ef4444; }

@media (max-width: 768px) {
  .statistics-grid {
    grid-template-columns: 1fr;
  }
}
</style>
{% endblock %}
