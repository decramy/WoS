{% extends 'backlog/base.html' %}
{% load static icon_tags %}

{% block title %}Stories â€” WoS{% endblock %}

{% block content %}
<div class="page-head">
  <h2>ğŸ“‹ {% if show_archived %}Archived {% endif %}Stories</h2>
  <div class="page-actions">
    {% if show_archived %}
      <a class="btn" href="{% url 'backlog:stories' %}">â† Active Stories</a>
    {% else %}
      <a class="btn" href="{% url 'backlog:stories' %}?archived=1">ğŸ“¦ View Archived</a>
      <a class="btn" href="{% url 'backlog:story_create' %}?next={{ request.get_full_path|urlencode }}">â• Create Story</a>
    {% endif %}
  </div>
</div>

<div class="page-hint">
  {% if show_archived %}
  <strong>ğŸ“¦ Archived Stories:</strong> These stories have been archived and are hidden from the main view.
  You can unarchive them to bring them back.
  {% else %}
  <strong>ğŸ’¡ Tip:</strong> Stories are individual units of work. The <strong>ğŸ“</strong> column shows if details (title, goal, workitems) are complete, 
  <strong>ğŸ“Š</strong> shows if all WSJF scoring factors are defined, and <strong>ğŸš©</strong> indicates stories needing review.
  {% endif %}
</div>

<form method="get" class="filters" style="margin-bottom:12px;display:flex;gap:8px;flex-wrap:wrap;align-items:center">
  {% if show_archived %}<input type="hidden" name="archived" value="1">{% endif %}
  <label for="status-select">ğŸ·ï¸ Status:</label>
  <select id="status-select" name="status" onchange="this.form.submit()">
    <option value="">All Statuses</option>
    {% for st in all_statuses %}
      <option value="{{ st }}" {% if st == status_filter %}selected{% endif %}>{{ st|upper }}</option>
    {% endfor %}
  </select>
  <label for="review-select">ğŸš© Review:</label>
  <select id="review-select" name="review" onchange="this.form.submit()">
    <option value="">All</option>
    <option value="yes" {% if review_filter == 'yes' %}selected{% endif %}>Required</option>
    <option value="no" {% if review_filter == 'no' %}selected{% endif %}>Not Required</option>
  </select>
  {% include 'backlog/_label_filter.html' %}
  <input name="q" placeholder="ğŸ” Search stories..." value="{{ q }}">
  <button class="btn" type="submit">Filter</button>
</form>

<!-- Bulk Actions Bar -->
<div id="bulk-actions-bar" class="bulk-actions-bar" style="display:none;">
  <div class="bulk-actions-info">
    <span id="selected-count">0</span> stories selected
    <button type="button" class="btn-link" onclick="toggleSelectAll(false)">Clear selection</button>
  </div>
  <div class="bulk-actions-buttons">
    <button type="button" class="btn btn-small" onclick="showBulkLabelModal()" title="Add labels to selected stories">ğŸ·ï¸ Add Labels</button>
    <button type="button" class="btn btn-small" onclick="bulkAction('set_review', true)" title="Flag selected stories for review">ğŸš© Set Review</button>
    <button type="button" class="btn btn-small" onclick="bulkAction('clear_review')" title="Clear review flag from selected stories">âœ… Clear Review</button>
    <button type="button" class="btn btn-small" onclick="showBulkBlockedModal()" title="Mark selected stories as blocked">ğŸš« Mark Blocked</button>
    {% if show_archived %}
    <button type="button" class="btn btn-small" onclick="bulkAction('unarchive')" title="Unarchive selected stories">ğŸ“¤ Unarchive</button>
    {% else %}
    <button type="button" class="btn btn-small" onclick="bulkAction('archive')" title="Archive selected stories">ğŸ“¦ Archive</button>
    {% endif %}
    <button type="button" class="btn btn-small btn-danger" onclick="bulkAction('delete')" title="Delete selected stories">ğŸ—‘ï¸ Delete</button>
  </div>
</div>

<form id="bulk-action-form" method="post" action="{% url 'backlog:stories_bulk_action' %}">
  {% csrf_token %}
  <input type="hidden" name="action" id="bulk-action-type" value="">
  <input type="hidden" name="story_ids" id="bulk-story-ids" value="">
  <input type="hidden" name="blocked_reason" id="bulk-blocked-reason" value="">
  <input type="hidden" name="label_ids" id="bulk-label-ids" value="">
  <input type="hidden" name="next" value="{{ request.get_full_path }}">
</form>

<table class="overview-table" style="margin-top:12px;">
  <thead>
    <tr>
      <th style="width:30px;"><input type="checkbox" id="select-all" onclick="toggleSelectAll(this.checked)" title="Select all"></th>
      <th>Actions</th>
      <th>
        <a href="?{% if q %}q={{ q }}&{% endif %}{% if status_filter %}status={{ status_filter }}&{% endif %}{% if review_filter %}review={{ review_filter }}&{% endif %}{% if labels_param %}labels={{ labels_param }}&{% endif %}{% if show_archived %}archived=1&{% endif %}sort=title&order={% if sort == 'title' and order == 'asc' %}desc{% else %}asc{% endif %}">
          Story
          {% if sort == 'title' %}{% if order == 'asc' %} â–² {% else %} â–¼ {% endif %}{% endif %}
        </a>
      </th>
      <th>
        <a href="?{% if q %}q={{ q }}&{% endif %}{% if status_filter %}status={{ status_filter }}&{% endif %}{% if review_filter %}review={{ review_filter }}&{% endif %}{% if labels_param %}labels={{ labels_param }}&{% endif %}{% if show_archived %}archived=1&{% endif %}sort=status&order={% if sort == 'status' and order == 'asc' %}desc{% else %}asc{% endif %}">
          ğŸ·ï¸ Status
          {% if sort == 'status' %}{% if order == 'asc' %} â–² {% else %} â–¼ {% endif %}{% endif %}
        </a>
      </th>
      <th title="Story details complete (title, goal, workitems)">ğŸ“</th>
      <th title="All WSJF score factors defined">ğŸ“Š</th>
    </tr>
  </thead>
  <tbody>
    {% for item in stories %}
      <tr data-story-id="{{ item.story.id }}">
        <td><input type="checkbox" class="story-checkbox" value="{{ item.story.id }}" onchange="updateBulkSelection()"></td>
        <td style="white-space:nowrap;">
          <a href="{% url 'backlog:story_detail' item.story.id %}?next={{ request.get_full_path|urlencode }}" title="Edit story">ğŸ”§</a>
          {% if show_archived %}
            <form method="post" action="" style="display:inline;">
              {% csrf_token %}
              <input type="hidden" name="action" value="unarchive_story">
              <input type="hidden" name="story_id" value="{{ item.story.id }}">
              <button type="submit" title="Unarchive story" style="background:none;border:0;padding:0;margin:0;cursor:pointer;">ğŸ“¤</button>
            </form>
          {% else %}
            <form method="post" action="" style="display:inline;">
              {% csrf_token %}
              <input type="hidden" name="action" value="archive_story">
              <input type="hidden" name="story_id" value="{{ item.story.id }}">
              <button type="submit" title="Archive story" style="background:none;border:0;padding:0;margin:0;cursor:pointer;">ğŸ“¦</button>
            </form>
            <form method="post" action="" style="display:inline;">
              {% csrf_token %}
              <input type="hidden" name="action" value="toggle_review">
              <input type="hidden" name="story_id" value="{{ item.story.id }}">
              <button type="submit" title="{% if item.story.review_required %}Clear review flag{% else %}Flag for review{% endif %}" style="background:none;border:0;padding:0;margin:0;cursor:pointer;">{% if item.story.review_required %}âœ…{% else %}ğŸš©{% endif %}</button>
            </form>
          {% endif %}
          <form method="post" action="{% url 'backlog:stories' %}" style="display:inline;">
            {% csrf_token %}
            <input type="hidden" name="action" value="delete_story">
            <input type="hidden" name="story_id" value="{{ item.story.id }}">
            <button type="submit" title="Delete story" style="background:none;border:0;padding:0;margin:0;cursor:pointer;">ğŸ—‘ï¸</button>
          </form>
        </td>
        <td>
          <div class="story-title-cell">
            <a href="{% url 'backlog:story_detail' item.story.id %}?next={{ request.get_full_path|urlencode }}" class="table-link">{% if item.story.review_required %}<span class="review-flag" title="Review required">ğŸš©</span> {% endif %}{{ item.story.title }}</a>
            {% if item.story.labels.exists %}
            <div class="labels-row">
              {% for label in item.story.labels.all %}
              <span class="label-shield label-small" style="--label-color: {{ label.category.color }};" title="{{ label.category.name }}: {{ label.name }}">
                <span class="label-icon">{% render_icon label.category.icon %}</span>
                <span class="label-text">{{ label.name }}</span>
              </span>
              {% endfor %}
            </div>
            {% endif %}
          </div>
        </td>
        <td><strong class="status-{{ item.story.computed_status }}">{{ item.story.computed_status|upper }}</strong></td>
        <td style="text-align:center;">{% if item.details_complete %}<span style="color:var(--accent-2);" title="âœ“ Details complete">âœ…</span>{% else %}<span style="color:var(--danger);" title="âœ— Missing: title, goal or workitems">âš ï¸</span>{% endif %}</td>
        <td style="text-align:center;">{% if item.scores_complete %}<span style="color:var(--accent-2);" title="âœ“ All scores defined">âœ…</span>{% else %}<span style="color:var(--danger);" title="âœ— Some scores undefined">âš ï¸</span>{% endif %}</td>
      </tr>
    {% empty %}
      <tr>
        <td colspan="6">
          <div class="empty-state">
            <div class="empty-icon">{% if show_archived %}ğŸ“¦{% else %}ğŸ“‹{% endif %}</div>
            <div class="empty-text">No {% if show_archived %}archived {% endif %}stories found</div>
            <div class="empty-hint">{% if show_archived %}No stories have been archived.{% else %}Create a story or adjust your filters{% endif %}</div>
          </div>
        </td>
      </tr>
    {% endfor %}
  </tbody>
</table>

<!-- Bulk Label Modal -->
<div id="bulk-label-modal" class="modal" style="display:none;">
  <div class="modal-content">
    <div class="modal-header">
      <h3>ğŸ·ï¸ Add Labels to Selected Stories</h3>
      <button type="button" class="modal-close" onclick="closeBulkLabelModal()">&times;</button>
    </div>
    <div class="modal-body">
      <p>Select labels to add to the selected stories:</p>
      <div class="label-select-grid">
        {% for category in all_label_categories %}
        <div class="label-category-group">
          <div class="category-header" style="--cat-color: {{ category.color }};">
            <span class="category-icon">{% render_icon category.icon %}</span>
            {{ category.name }}
          </div>
          <div class="category-labels">
            {% for label in category.labels.all %}
            <label class="label-checkbox">
              <input type="checkbox" name="bulk_labels" value="{{ label.id }}">
              <span class="label-shield label-small" style="--label-color: {{ label.category.color }};">
                <span class="label-text">{{ label.name }}</span>
              </span>
            </label>
            {% empty %}
            <span class="no-labels">No labels</span>
            {% endfor %}
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn" onclick="closeBulkLabelModal()">Cancel</button>
      <button type="button" class="btn btn-primary" onclick="applyBulkLabels()">Apply Labels</button>
    </div>
  </div>
</div>

<!-- Bulk Blocked Modal -->
<div id="bulk-blocked-modal" class="modal" style="display:none;">
  <div class="modal-content">
    <div class="modal-header">
      <h3>ğŸš« Mark Stories as Blocked</h3>
      <button type="button" class="modal-close" onclick="closeBulkBlockedModal()">&times;</button>
    </div>
    <div class="modal-body">
      <p>Enter the reason why these stories are blocked:</p>
      <textarea id="blocked-reason-input" placeholder="e.g., Waiting for API, Dependency on external team..." rows="3" style="width:100%;"></textarea>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn" onclick="closeBulkBlockedModal()">Cancel</button>
      <button type="button" class="btn btn-primary" onclick="applyBulkBlocked()">Mark as Blocked</button>
    </div>
  </div>
</div>

<script>
function getSelectedStoryIds() {
  var checkboxes = document.querySelectorAll('.story-checkbox:checked');
  return Array.from(checkboxes).map(function(cb) { return cb.value; });
}

function updateBulkSelection() {
  var selected = getSelectedStoryIds();
  var bar = document.getElementById('bulk-actions-bar');
  var countEl = document.getElementById('selected-count');
  var selectAll = document.getElementById('select-all');
  var allCheckboxes = document.querySelectorAll('.story-checkbox');
  
  countEl.textContent = selected.length;
  bar.style.display = selected.length > 0 ? 'flex' : 'none';
  
  // Update select-all checkbox state
  if (allCheckboxes.length > 0) {
    selectAll.checked = selected.length === allCheckboxes.length;
    selectAll.indeterminate = selected.length > 0 && selected.length < allCheckboxes.length;
  }
}

function toggleSelectAll(checked) {
  var checkboxes = document.querySelectorAll('.story-checkbox');
  checkboxes.forEach(function(cb) { cb.checked = checked; });
  updateBulkSelection();
}

function bulkAction(action, confirm_msg) {
  var selected = getSelectedStoryIds();
  if (selected.length === 0) {
    alert('Please select at least one story.');
    return;
  }
  
  // Confirmation for destructive actions
  if (action === 'delete') {
    if (!confirm('Are you sure you want to delete ' + selected.length + ' stories? This cannot be undone.')) {
      return;
    }
  } else if (action === 'archive') {
    if (!confirm('Archive ' + selected.length + ' stories?')) {
      return;
    }
  }
  
  document.getElementById('bulk-action-type').value = action;
  document.getElementById('bulk-story-ids').value = selected.join(',');
  document.getElementById('bulk-action-form').submit();
}

function showBulkLabelModal() {
  var selected = getSelectedStoryIds();
  if (selected.length === 0) {
    alert('Please select at least one story.');
    return;
  }
  // Clear previous selections
  document.querySelectorAll('#bulk-label-modal input[name="bulk_labels"]').forEach(function(cb) {
    cb.checked = false;
  });
  document.getElementById('bulk-label-modal').style.display = 'flex';
}

function closeBulkLabelModal() {
  document.getElementById('bulk-label-modal').style.display = 'none';
}

function applyBulkLabels() {
  var selected = getSelectedStoryIds();
  var labelCheckboxes = document.querySelectorAll('#bulk-label-modal input[name="bulk_labels"]:checked');
  var labelIds = Array.from(labelCheckboxes).map(function(cb) { return cb.value; });
  
  if (labelIds.length === 0) {
    alert('Please select at least one label.');
    return;
  }
  
  document.getElementById('bulk-action-type').value = 'add_labels';
  document.getElementById('bulk-story-ids').value = selected.join(',');
  document.getElementById('bulk-label-ids').value = labelIds.join(',');
  document.getElementById('bulk-action-form').submit();
}

function showBulkBlockedModal() {
  var selected = getSelectedStoryIds();
  if (selected.length === 0) {
    alert('Please select at least one story.');
    return;
  }
  document.getElementById('blocked-reason-input').value = '';
  document.getElementById('bulk-blocked-modal').style.display = 'flex';
}

function closeBulkBlockedModal() {
  document.getElementById('bulk-blocked-modal').style.display = 'none';
}

function applyBulkBlocked() {
  var selected = getSelectedStoryIds();
  var reason = document.getElementById('blocked-reason-input').value.trim();
  
  if (!reason) {
    alert('Please enter a reason for blocking.');
    return;
  }
  
  document.getElementById('bulk-action-type').value = 'set_blocked';
  document.getElementById('bulk-story-ids').value = selected.join(',');
  document.getElementById('bulk-blocked-reason').value = reason;
  document.getElementById('bulk-action-form').submit();
}

// Close modals on Escape key
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    closeBulkLabelModal();
    closeBulkBlockedModal();
  }
});

// Close modals when clicking outside
document.querySelectorAll('.modal').forEach(function(modal) {
  modal.addEventListener('click', function(e) {
    if (e.target === modal) {
      modal.style.display = 'none';
    }
  });
});
</script>
{% endblock %}
