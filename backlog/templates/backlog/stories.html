{% extends 'backlog/base.html' %}
{% load static %}

{% block title %}Stories â€” WoS{% endblock %}

{% block content %}
<div class="page-head">
  <h2>ğŸ“‹ {% if show_archived %}Archived {% endif %}Stories</h2>
  <div class="page-actions">
    {% if show_archived %}
      <a class="btn" href="{% url 'backlog:stories' %}">â† Active Stories</a>
    {% else %}
      <a class="btn" href="{% url 'backlog:stories' %}?archived=1">ğŸ“¦ View Archived</a>
      <a class="btn" href="{% url 'backlog:story_create' %}?next={{ request.get_full_path|urlencode }}{% if epic_id %}&epic={{ epic_id }}{% endif %}">â• Create Story</a>
    {% endif %}
  </div>
</div>

<div class="page-hint">
  {% if show_archived %}
  <strong>ğŸ“¦ Archived Stories:</strong> These stories have been archived and are hidden from the main view.
  You can unarchive them to bring them back.
  {% else %}
  <strong>ğŸ’¡ Tip:</strong> Stories are individual units of work. The <strong>ğŸ“</strong> column shows if details (title, goal, workitems) are complete, 
  <strong>ğŸ“Š</strong> shows if all WSJF scoring factors are defined, and <strong>ğŸš©</strong> indicates stories needing review.
  {% endif %}
</div>

<form method="get" class="filters" style="margin-bottom:12px;display:flex;gap:8px;flex-wrap:wrap;align-items:center">
  {% if show_archived %}<input type="hidden" name="archived" value="1">{% endif %}
  <label for="epic-select">ğŸ“ Epic:</label>
  <select id="epic-select" name="epic" onchange="this.form.submit()">
    <option value="">All Epics</option>
    {% for e in all_epics %}
      <option value="{{ e.id }}" {% if e.id|stringformat:"s" == epic_id|stringformat:"s" %}selected{% endif %}>{{ e.title }}</option>
    {% endfor %}
  </select>
  <label for="status-select">ğŸ·ï¸ Status:</label>
  <select id="status-select" name="status" onchange="this.form.submit()">
    <option value="">All Statuses</option>
    {% for st in all_statuses %}
      <option value="{{ st }}" {% if st == status_filter %}selected{% endif %}>{{ st|upper }}</option>
    {% endfor %}
  </select>
  <label for="review-select">ğŸš© Review:</label>
  <select id="review-select" name="review" onchange="this.form.submit()">
    <option value="">All</option>
    <option value="yes" {% if review_filter == 'yes' %}selected{% endif %}>Required</option>
    <option value="no" {% if review_filter == 'no' %}selected{% endif %}>Not Required</option>
  </select>
  <input name="q" placeholder="ğŸ” Search stories..." value="{{ q }}">
  <button class="btn" type="submit">Filter</button>
</form>
<table class="overview-table" style="margin-top:12px;">
  <thead>
    <tr>
      <th>Actions</th>
      <th>
        <a href="?{% if q %}q={{ q }}&{% endif %}{% if epic_id %}epic={{ epic_id }}&{% endif %}{% if status_filter %}status={{ status_filter }}&{% endif %}{% if review_filter %}review={{ review_filter }}&{% endif %}{% if show_archived %}archived=1&{% endif %}sort=epic&order={% if sort == 'epic' and order == 'asc' %}desc{% else %}asc{% endif %}">
          ğŸ“ Epic
          {% if sort == 'epic' %}{% if order == 'asc' %} â–² {% else %} â–¼ {% endif %}{% endif %}
        </a>
      </th>
      <th>
        <a href="?{% if q %}q={{ q }}&{% endif %}{% if epic_id %}epic={{ epic_id }}&{% endif %}{% if status_filter %}status={{ status_filter }}&{% endif %}{% if review_filter %}review={{ review_filter }}&{% endif %}{% if show_archived %}archived=1&{% endif %}sort=title&order={% if sort == 'title' and order == 'asc' %}desc{% else %}asc{% endif %}">
          Story
          {% if sort == 'title' %}{% if order == 'asc' %} â–² {% else %} â–¼ {% endif %}{% endif %}
        </a>
      </th>
      <th>
        <a href="?{% if q %}q={{ q }}&{% endif %}{% if epic_id %}epic={{ epic_id }}&{% endif %}{% if status_filter %}status={{ status_filter }}&{% endif %}{% if review_filter %}review={{ review_filter }}&{% endif %}{% if show_archived %}archived=1&{% endif %}sort=status&order={% if sort == 'status' and order == 'asc' %}desc{% else %}asc{% endif %}">
          ğŸ·ï¸ Status
          {% if sort == 'status' %}{% if order == 'asc' %} â–² {% else %} â–¼ {% endif %}{% endif %}
        </a>
      </th>
      <th title="Story details complete (title, goal, workitems)">ğŸ“</th>
      <th title="All WSJF score factors defined">ğŸ“Š</th>
      <th title="Review required">ğŸš©</th>
    </tr>
  </thead>
  <tbody>
    {% for item in stories %}
      <tr>
        <td style="white-space:nowrap;">
          <a href="{% url 'backlog:story_detail' item.story.id %}?next={{ request.get_full_path|urlencode }}" title="Edit story">ğŸ”§</a>
          {% if show_archived %}
            <form method="post" action="" style="display:inline;">
              {% csrf_token %}
              <input type="hidden" name="action" value="unarchive_story">
              <input type="hidden" name="story_id" value="{{ item.story.id }}">
              <button type="submit" title="Unarchive story" style="background:none;border:0;padding:0;margin:0;cursor:pointer;">ğŸ“¤</button>
            </form>
          {% else %}
            <form method="post" action="" style="display:inline;">
              {% csrf_token %}
              <input type="hidden" name="action" value="archive_story">
              <input type="hidden" name="story_id" value="{{ item.story.id }}">
              <button type="submit" title="Archive story" style="background:none;border:0;padding:0;margin:0;cursor:pointer;">ğŸ“¦</button>
            </form>
            <form method="post" action="" style="display:inline;">
              {% csrf_token %}
              <input type="hidden" name="action" value="toggle_review">
              <input type="hidden" name="story_id" value="{{ item.story.id }}">
              <button type="submit" title="{% if item.story.review_required %}Clear review flag{% else %}Flag for review{% endif %}" style="background:none;border:0;padding:0;margin:0;cursor:pointer;">{% if item.story.review_required %}âœ…{% else %}ğŸš©{% endif %}</button>
            </form>
          {% endif %}
          <form method="post" action="{% url 'backlog:stories' %}" style="display:inline;">
            {% csrf_token %}
            <input type="hidden" name="action" value="delete_story">
            <input type="hidden" name="story_id" value="{{ item.story.id }}">
            <button type="submit" title="Delete story" style="background:none;border:0;padding:0;margin:0;cursor:pointer;">ğŸ—‘ï¸</button>
          </form>
        </td>
        <td style="color:var(--muted);">{{ item.story.epic.title }}</td>
        <td><a href="{% url 'backlog:story_detail' item.story.id %}?next={{ request.get_full_path|urlencode }}" class="table-link">{% if item.story.review_required %}ğŸš© {% endif %}{{ item.story.title }}</a></td>
        <td><strong class="status-{{ item.story.computed_status }}">{{ item.story.computed_status|upper }}</strong></td>
        <td style="text-align:center;">{% if item.details_complete %}<span style="color:var(--accent-2);" title="âœ“ Details complete">âœ…</span>{% else %}<span style="color:var(--danger);" title="âœ— Missing: title, goal or workitems">âš ï¸</span>{% endif %}</td>
        <td style="text-align:center;">{% if item.scores_complete %}<span style="color:var(--accent-2);" title="âœ“ All scores defined">âœ…</span>{% else %}<span style="color:var(--danger);" title="âœ— Some scores undefined">âš ï¸</span>{% endif %}</td>
        <td style="text-align:center;">{% if item.story.review_required %}<span style="color:var(--warning);" title="Review required">ğŸš©</span>{% else %}â€”{% endif %}</td>
      </tr>
    {% empty %}
      <tr>
        <td colspan="7">
          <div class="empty-state">
            <div class="empty-icon">{% if show_archived %}ğŸ“¦{% else %}ğŸ“‹{% endif %}</div>
            <div class="empty-text">No {% if show_archived %}archived {% endif %}stories found</div>
            <div class="empty-hint">{% if show_archived %}No stories have been archived.{% else %}Create a story or adjust your filters{% endif %}</div>
          </div>
        </td>
      </tr>
    {% endfor %}
  </tbody>
</table>
{% endblock %}
