{% extends 'backlog/base.html' %}

{% block title %}Edit Epic ‚Äî {{ epic.title }}{% endblock %}

{% block content %}
<div class="page-hint">
  <strong>üìö Edit Epic:</strong> Update this epic's title and description. Stories linked to this epic will remain unchanged.
</div>

<form method="post" action="" class="page-content-with-fixed-bar" id="epic-form">
  {% csrf_token %}
  <input type="hidden" name="next" value="{{ next_url }}">
  
  <!-- Big clickable title -->
  <h1 id="title-display" class="title-display" onclick="showTitleInput()">
    {{ epic.title }}
  </h1>
  <input type="text" id="title-input" class="title-input" name="title" value="{{ epic.title }}" placeholder="Epic title..." onblur="hideTitleInput()" required>

  <!-- Epic Details -->
  <div class="content-section">
    <h3>üìù Epic Details</h3>
    <p class="section-hint">Provide context about what this epic aims to achieve.</p>
    <div class="text-fields">
      <div class="form-group">
        <label for="epic_description" class="field-title">Description</label>
        <textarea id="epic_description" name="description" rows="5" placeholder="Describe the epic's goals and scope...">{{ epic.description }}</textarea>
        <p class="field-hint">üí° A good description helps the team understand the purpose and scope.</p>
      </div>
    </div>
  </div>
</form>

<!-- Fixed save bar at bottom of screen -->
<div class="fixed-save-bar">
  <button type="submit" form="epic-form">üíæ Save Epic</button>
  <a href="{{ next_url|default:back_url }}" class="back-link">‚Üê Back to Epics</a>
</div>

<script>
// Form change tracking for save button
var formChanged = false;
var initialFormState = '';
var saveButton = null;

function getFormState() {
  var form = document.getElementById('epic-form');
  var formData = new FormData(form);
  var state = [];
  for (var pair of formData.entries()) {
    if (pair[0] !== 'csrfmiddlewaretoken') {
      state.push(pair[0] + '=' + pair[1]);
    }
  }
  return state.sort().join('&');
}

function updateSaveButton() {
  var currentState = getFormState();
  formChanged = (currentState !== initialFormState);
  if (saveButton) {
    saveButton.disabled = !formChanged;
  }
}

function showTitleInput() {
  document.getElementById('title-display').classList.add('hidden');
  var input = document.getElementById('title-input');
  input.classList.add('active');
  input.focus();
  input.select();
}

function hideTitleInput() {
  var input = document.getElementById('title-input');
  var display = document.getElementById('title-display');
  var value = input.value.trim();
  display.textContent = value || 'Click to add title...';
  input.classList.remove('active');
  display.classList.remove('hidden');
}

// Add form validation and change tracking
document.addEventListener('DOMContentLoaded', function() {
  var form = document.getElementById('epic-form');
  var titleInput = document.getElementById('title-input');
  
  // Initialize save button state
  saveButton = document.querySelector('.fixed-save-bar button[form="epic-form"]');
  initialFormState = getFormState();
  if (saveButton) saveButton.disabled = true;
  
  // Listen for changes on all form elements
  form.querySelectorAll('input, select, textarea').forEach(function(el) {
    el.addEventListener('change', updateSaveButton);
    el.addEventListener('input', updateSaveButton);
  });
  
  form.addEventListener('submit', function(e) {
    var title = titleInput.value.trim();
    if (!title) {
      e.preventDefault();
      alert('‚ö†Ô∏è Please enter a title for the epic');
      document.getElementById('title-display').classList.add('hidden');
      titleInput.classList.add('active');
      titleInput.focus();
      return false;
    }
  });
});
</script>
{% endblock %}
