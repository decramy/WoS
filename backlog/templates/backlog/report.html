{% extends 'backlog/base.html' %}
{% load static icon_tags %}

{% block title %}Report â€” WoS{% endblock %}

{% block content %}
<div class="page-head">
  <h2>ğŸ“Š WSJF Score Report</h2>
  <div class="page-actions">
    <button class="btn" id="toggle-tweak-mode" title="Enable tweaking scores to see ordering changes">ğŸ”§ Tweak Mode</button>
    <button class="btn" id="reset-tweaks" style="display:none;" title="Reset all tweaked values">â†©ï¸ Reset</button>
    <a class="btn" href="{% url 'backlog:stories' %}">ğŸ“‹ Stories</a>
    <a class="btn" href="{% url 'backlog:kanban' %}">ğŸ“Œ Kanban</a>
  </div>
</div>

<div class="page-hint">
  <strong>ğŸ’¡ How WSJF works:</strong> Stories are scored by <strong>Value</strong> (business benefit) and <strong>Cost</strong> (effort). 
  The <strong>Result = Value Ã· Cost</strong> â€” higher is better! ğŸŸ¢ Green rows have the best scores, ğŸ”´ red rows the lowest.
  Click any column header to sort.
</div>

<div id="tweak-hint" class="page-hint" style="display:none; background: var(--warning-bg, #fff3cd); border-left: 4px solid var(--warning, #ffc107);">
  <strong>ğŸ”§ Tweak Mode Active:</strong> Click on <strong>Value</strong> or <strong>Cost</strong> cells to temporarily adjust scores and see how ordering changes.
  Changes are <strong>NOT saved</strong> â€” use the refine page to save actual changes.
</div>

<form method="get" class="filters" style="margin-bottom:12px;display:flex;gap:8px;flex-wrap:wrap;align-items:center">
  <label for="status-select">ğŸ·ï¸ Status:</label>
  <select id="status-select" name="status" onchange="this.form.submit()">
    <option value="">All Statuses</option>
    <option value="idea" {% if status_filter == 'idea' %}selected{% endif %}>IDEA</option>
    <option value="ready" {% if status_filter == 'ready' %}selected{% endif %}>READY</option>
    <option value="planned" {% if status_filter == 'planned' %}selected{% endif %}>PLANNED</option>
    <option value="started" {% if status_filter == 'started' %}selected{% endif %}>STARTED</option>
    <option value="blocked" {% if status_filter == 'blocked' %}selected{% endif %}>BLOCKED</option>
    <option value="done" {% if status_filter == 'done' %}selected{% endif %}>DONE</option>
  </select>
  {% include 'backlog/_label_filter.html' %}
</form>

<table class="overview-table" id="report-table" style="margin-top:12px;">
  <thead>
    <tr>
      <th class="sortable">
        ğŸ“‹ Story <span class="sort-icon"></span>
      </th>
      <th class="sortable">
        ğŸ·ï¸ Status <span class="sort-icon"></span>
      </th>
      {% for vs in value_sections %}
        <th class="sortable" title="Value: {{ vs.name }}">
          V: {{ vs.name|truncatechars:12 }} <span class="sort-icon"></span>
        </th>
      {% endfor %}
      <th class="sortable" title="Total Value Score">
        ğŸ’ Value <span class="sort-icon"></span>
      </th>
      {% for cs in cost_sections %}
        <th class="sortable" title="Cost: {{ cs.name }}">
          C: {{ cs.name|truncatechars:12 }} <span class="sort-icon"></span>
        </th>
      {% endfor %}
      <th class="sortable" title="Total Cost Score">
        âš¡ Cost <span class="sort-icon"></span>
      </th>
      <th class="sortable" title="WSJF Result (Value Ã· Cost)">
        ğŸ¯ Result <span class="sort-icon"></span>
      </th>
    </tr>
  </thead>
  <tbody>
    {% for r in rows %}
      <tr data-result="{% if r.result is not None %}{{ r.result }}{% endif %}">
        <td>
          <div class="story-title-cell">
            <a href="{% url 'backlog:story_detail' r.story.id %}" class="table-link">{% if r.story.review_required %}<span class="review-flag" title="Review required">ğŸš©</span> {% endif %}{{ r.story.title|truncatechars:30 }}</a>
            {% if r.story.labels.exists %}
            <div class="labels-row">
              {% for label in r.story.labels.all %}
              <span class="label-shield label-small" style="--label-color: {{ label.category.color }};" title="{{ label.category.name }}: {{ label.name }}">
                <span class="label-icon">{% render_icon label.category.icon %}</span>
                <span class="label-text">{{ label.name }}</span>
              </span>
              {% endfor %}
            </div>
            {% endif %}
          </div>
        </td>
        <td class="status-{{ r.story.computed_status }}" data-value="{{ r.story.computed_status }}">
          {{ r.story.computed_status|upper }}
        </td>
        {% for section_data in r.value_section_data %}
          <td class="score-cell" data-value="{% if section_data.avg is not None %}{{ section_data.avg }}{% else %}-999{% endif %}" style="text-align:center;" title="{{ section_data.tooltip }}">
            {% if section_data.avg is not None %}
              {{ section_data.avg|floatformat:1 }}
            {% else %}
              <span style="color:var(--muted);">â€”</span>
            {% endif %}
          </td>
        {% endfor %}
        <td class="value-total-cell" data-value="{{ r.value_sum }}" data-original="{{ r.value_sum }}" data-story-id="{{ r.story.id }}" style="text-align:center;font-weight:600;" title="{{ r.value_total_tooltip }}">
          <span class="display-value">{{ r.value_sum|floatformat:1 }}</span>
          <input type="number" class="tweak-input" value="{{ r.value_sum }}" min="0" step="0.1" style="display:none; width:60px; text-align:center;">
        </td>
        {% for section_data in r.cost_section_data %}
          <td class="score-cell" data-value="{% if section_data.avg is not None %}{{ section_data.avg }}{% else %}-999{% endif %}" style="text-align:center;" title="{{ section_data.tooltip }}">
            {% if section_data.avg is not None %}
              {{ section_data.avg|floatformat:1 }}
            {% else %}
              <span style="color:var(--muted);">â€”</span>
            {% endif %}
          </td>
        {% endfor %}
        <td class="cost-total-cell" data-value="{{ r.cost_sum }}" data-original="{{ r.cost_sum }}" data-story-id="{{ r.story.id }}" style="text-align:center;font-weight:600;" title="{{ r.cost_total_tooltip }}">
          <span class="display-value">{{ r.cost_sum|floatformat:1 }}</span>
          <input type="number" class="tweak-input" value="{{ r.cost_sum }}" min="0" step="0.1" style="display:none; width:60px; text-align:center;">
        </td>
        <td class="result-cell" data-value="{% if r.result is not None %}{{ r.result }}{% else %}-999{% endif %}" data-story-id="{{ r.story.id }}" style="text-align:center;" title="{{ r.result_tooltip }}">
          {% if r.result is None %}
            <span style="color:var(--muted);">â€”</span>
          {% else %}
            <strong>{{ r.result|floatformat:2 }}</strong>
          {% endif %}
        </td>
      </tr>
    {% empty %}
      <tr>
        <td colspan="{{ total_cols }}">
          <div class="empty-state">
            <div class="empty-icon">ğŸ“Š</div>
            <div class="empty-text">No stories found</div>
            <div class="empty-hint">Create some stories and score them to see results here.</div>
          </div>
        </td>
      </tr>
    {% endfor %}
  </tbody>
</table>

<style>
  /* Sortable header styling */
  .overview-table th.sortable { 
    cursor: pointer; 
    user-select: none; 
    transition: background 0.15s; 
    white-space: nowrap;
  }
  .overview-table th.sortable:hover { background: var(--surface); }
  .overview-table th .sort-icon { font-size: 10px; margin-left: 4px; opacity: 0.4; }
  .overview-table th.sort-asc .sort-icon::after { content: 'â–²'; opacity: 1; }
  .overview-table th.sort-desc .sort-icon::after { content: 'â–¼'; opacity: 1; }
  
  /* Result cell emphasis */
  .result-cell { font-weight: 600; }
  
  /* Row gradient colors will be applied via JS */
  #report-table tbody tr {
    transition: background 0.2s;
  }
  
  /* Tweak mode styles */
  .tweak-mode .value-total-cell,
  .tweak-mode .cost-total-cell {
    cursor: pointer;
    position: relative;
  }
  .tweak-mode .value-total-cell:hover,
  .tweak-mode .cost-total-cell:hover {
    background: var(--surface) !important;
    outline: 2px dashed var(--primary, #007bff);
  }
  .tweak-input {
    border: 1px solid var(--primary, #007bff);
    border-radius: 4px;
    padding: 2px 4px;
    font-weight: 600;
    background: var(--bg);
    color: var(--text);
  }
  .tweak-input:focus {
    outline: none;
    box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
  }
  .tweaked {
    background: rgba(255, 193, 7, 0.2) !important;
  }
  .tweaked .display-value {
    color: var(--warning, #ffc107);
  }
  .tweaked .display-value::after {
    content: ' *';
    font-size: 0.8em;
  }
  #toggle-tweak-mode.active {
    background: var(--warning, #ffc107);
    color: #000;
  }
</style>

<script>
(function() {
  var table = document.getElementById('report-table');
  var tbody = table.querySelector('tbody');
  var headers = table.querySelectorAll('th.sortable');
  var currentSort = { col: -1, asc: true };
  
  // Sorting functionality
  headers.forEach(function(header, index) {
    header.addEventListener('click', function() {
      var col = index;
      var asc = currentSort.col === col ? !currentSort.asc : true;
      
      // Update sort state
      currentSort = { col: col, asc: asc };
      
      // Update header classes
      headers.forEach(function(h) {
        h.classList.remove('sort-asc', 'sort-desc');
      });
      this.classList.add(asc ? 'sort-asc' : 'sort-desc');
      
      // Sort rows
      var rows = Array.from(tbody.querySelectorAll('tr'));
      rows.sort(function(a, b) {
        var aCell = a.cells[col];
        var bCell = b.cells[col];
        
        if (!aCell || !bCell) return 0;
        
        // Get sort value - use data-value if available, otherwise text content
        var aVal = aCell.hasAttribute('data-value') ? aCell.getAttribute('data-value') : aCell.textContent.trim();
        var bVal = bCell.hasAttribute('data-value') ? bCell.getAttribute('data-value') : bCell.textContent.trim();
        
        // Try numeric comparison
        var aNum = parseFloat(aVal);
        var bNum = parseFloat(bVal);
        
        if (!isNaN(aNum) && !isNaN(bNum)) {
          return asc ? aNum - bNum : bNum - aNum;
        }
        
        // String comparison
        return asc ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
      });
      
      // Re-append sorted rows
      rows.forEach(function(row) {
        tbody.appendChild(row);
      });
      
      // Re-apply gradient colors
      applyGradientColors();
    });
  });
  
  // Gradient color function: Green (high) â†’ Yellow (mid) â†’ Red (low)
  function applyGradientColors() {
    var rows = document.querySelectorAll('#report-table tbody tr[data-result]');
    var results = [];
    
    rows.forEach(function(row) {
      var val = row.getAttribute('data-result');
      if (val && val !== '') {
        results.push(parseFloat(val));
      }
    });
    
    if (results.length === 0) return;
    
    var minResult = Math.min.apply(null, results);
    var maxResult = Math.max.apply(null, results);
    var range = maxResult - minResult;
    
    rows.forEach(function(row) {
      var val = row.getAttribute('data-result');
      if (!val || val === '') {
        row.style.background = 'var(--surface)';
        return;
      }
      
      var result = parseFloat(val);
      // ratio: 0 = lowest (red), 1 = highest (green)
      var ratio = range > 0 ? (result - minResult) / range : 0.5;
      
      var r, g, b;
      if (ratio < 0.5) {
        // Red to Yellow (low to mid)
        var t = ratio * 2;
        r = 255;
        g = Math.round(200 * t);
        b = Math.round(80 * (1 - t));
      } else {
        // Yellow to Green (mid to high)
        var t = (ratio - 0.5) * 2;
        r = Math.round(255 * (1 - t));
        g = Math.round(200 + 55 * t);
        b = Math.round(80 * t);
      }
      
      row.style.background = 'rgba(' + r + ',' + g + ',' + b + ', 0.18)';
    });
  }
  
  // Initial gradient application
  applyGradientColors();
  
  // Default sort: Result column (last column), descending
  var lastHeader = headers[headers.length - 1];
  if (lastHeader) {
    // Click twice: first for ascending, second for descending
    lastHeader.click(); // asc
    lastHeader.click(); // desc
  }
  
  // ===== TWEAK MODE FUNCTIONALITY =====
  var tweakMode = false;
  var toggleBtn = document.getElementById('toggle-tweak-mode');
  var resetBtn = document.getElementById('reset-tweaks');
  var tweakHint = document.getElementById('tweak-hint');
  
  // Toggle tweak mode
  toggleBtn.addEventListener('click', function() {
    tweakMode = !tweakMode;
    table.classList.toggle('tweak-mode', tweakMode);
    toggleBtn.classList.toggle('active', tweakMode);
    toggleBtn.textContent = tweakMode ? 'ğŸ”§ Tweak Mode ON' : 'ğŸ”§ Tweak Mode';
    tweakHint.style.display = tweakMode ? 'block' : 'none';
    
    // Show/hide reset button if there are any tweaked values
    updateResetButton();
  });
  
  // Reset all tweaked values
  resetBtn.addEventListener('click', function() {
    var tweakedCells = document.querySelectorAll('.value-total-cell.tweaked, .cost-total-cell.tweaked');
    tweakedCells.forEach(function(cell) {
      var original = cell.getAttribute('data-original');
      var displaySpan = cell.querySelector('.display-value');
      var input = cell.querySelector('.tweak-input');
      
      cell.setAttribute('data-value', original);
      displaySpan.textContent = original;
      input.value = original;
      cell.classList.remove('tweaked');
      
      // Update the result for this row
      updateRowResult(cell.closest('tr'));
    });
    
    applyGradientColors();
    updateResetButton();
  });
  
  function updateResetButton() {
    var hasTweaks = document.querySelectorAll('.value-total-cell.tweaked, .cost-total-cell.tweaked').length > 0;
    resetBtn.style.display = hasTweaks ? 'inline-block' : 'none';
  }
  
  // Make value and cost cells editable in tweak mode
  document.querySelectorAll('.value-total-cell, .cost-total-cell').forEach(function(cell) {
    var displaySpan = cell.querySelector('.display-value');
    var input = cell.querySelector('.tweak-input');
    
    // Click to edit
    cell.addEventListener('click', function(e) {
      if (!tweakMode) return;
      if (e.target === input) return;
      
      displaySpan.style.display = 'none';
      input.style.display = 'inline-block';
      input.focus();
      input.select();
    });
    
    // Handle input changes
    input.addEventListener('blur', function() {
      commitTweak(cell, input, displaySpan);
    });
    
    input.addEventListener('keydown', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        commitTweak(cell, input, displaySpan);
      } else if (e.key === 'Escape') {
        // Cancel edit, restore previous value
        input.value = cell.getAttribute('data-value');
        displaySpan.style.display = 'inline';
        input.style.display = 'none';
      }
    });
  });
  
  function commitTweak(cell, input, displaySpan) {
    var newValue = parseFloat(input.value) || 0;
    var original = parseFloat(cell.getAttribute('data-original'));
    
    cell.setAttribute('data-value', newValue);
    displaySpan.textContent = newValue;
    displaySpan.style.display = 'inline';
    input.style.display = 'none';
    
    // Mark as tweaked if different from original
    if (newValue !== original) {
      cell.classList.add('tweaked');
    } else {
      cell.classList.remove('tweaked');
    }
    
    // Update the result for this row
    updateRowResult(cell.closest('tr'));
    
    // Re-apply gradient colors
    applyGradientColors();
    updateResetButton();
  }
  
  function updateRowResult(row) {
    var valueCell = row.querySelector('.value-total-cell');
    var costCell = row.querySelector('.cost-total-cell');
    var resultCell = row.querySelector('.result-cell');
    
    if (!valueCell || !costCell || !resultCell) return;
    
    var value = parseFloat(valueCell.getAttribute('data-value')) || 0;
    var cost = parseFloat(costCell.getAttribute('data-value')) || 0;
    
    var result = null;
    if (cost > 0) {
      result = value / cost;
    }
    
    // Update result cell
    if (result !== null) {
      resultCell.setAttribute('data-value', result);
      resultCell.innerHTML = '<strong>' + result.toFixed(2) + '</strong>';
      row.setAttribute('data-result', result);
    } else {
      resultCell.setAttribute('data-value', '-999');
      resultCell.innerHTML = '<span style="color:var(--muted);">â€”</span>';
      row.setAttribute('data-result', '');
    }
    
    // Mark result cell as tweaked if any input is tweaked
    var hasTweak = valueCell.classList.contains('tweaked') || costCell.classList.contains('tweaked');
    resultCell.classList.toggle('tweaked', hasTweak);
  }
})();
</script>

{% endblock %}
